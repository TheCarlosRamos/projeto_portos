<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Concess√µes Portu√°rias - Apresenta√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #2E4E8C;
            --primary-dark: #243B6B;
            --primary-light: #3E5FA4;
            --accent-green: #2E7D32;
            --accent-yellow: #F7B500;
            --accent-red: #C62828;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: #4A4A4A;
            font-family: 'Inter', sans-serif;
        }

        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .project-card {
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        .project-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .modal-info-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .nav-item {
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        @media (min-width: 1024px) {
            .modal-info-grid {
                grid-template-areas:
                    'descricao mapa'
                    'etapa mapa';
                grid-template-columns: 1fr 1fr;
            }
            .card--descricao { grid-area: descricao; }
            .card--mapa { grid-area: mapa; }
            .card--etapa { grid-area: etapa; }
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 h-full shadow-xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <i class="fas fa-ship text-2xl text-blue-600"></i>
                    <h1 class="text-xl font-bold text-gray-800">Sistema Portu√°rio</h1>
                </div>
                
                <nav class="space-y-2">
                    <a href="/" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700">
                        <i class="fas fa-dashboard"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/cadastro" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700">
                        <i class="fas fa-plus-circle"></i>
                        <span>Cadastro</span>
                    </a>
                    <a href="/planilhas" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700">
                        <i class="fas fa-file-excel"></i>
                        <span>Planilhas</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="min-h-screen pb-12">
                <!-- Header -->
                <div class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gest√£o de Concess√µes Portu√°rias</h1>
                        <p class="text-gray-600 mt-2">Acompanhamento de Projetos de Concess√£o</p>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Search and Filter -->
            <div class="mb-6 flex gap-4">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="search-input" 
                           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Buscar projetos...">
                </div>
                <button id="reload-btn" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    Recarregar Dados
                </button>
            </div>

            <!-- Projects Grid -->
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards ser√£o inseridos aqui via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-800"></h2>
                    <div class="flex items-center gap-3">
                        <button id="edit-project-btn" onclick="toggleEditMode()" 
                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all duration-300">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="edit-btn-text">Editar Acompanhamento</span>
                        </button>
                        <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="modal-body" class="p-8 md:p-12">
                <!-- Conte√∫do ser√° inserido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let projetosData = [];
        let projetosFiltrados = [];
        let currentProject = null;
        let isEditMode = false;

        // Fun√ß√£o para converter UTM para Lat/Lon (WGS84)
        function utmToLatLon(easting, northing, zone) {
            try {
                // Par√¢metros do elipsoide WGS84
                const a = 6378137.0; // semi-eixo maior (metros)
                const f = 1 / 298.257223563; // achatamento
                const e2 = 2 * f - f * f; // primeira excentricidade ao quadrado
                const k0 = 0.9996; // fator de escala
                
                // Constantes
                const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
                
                // Remover falsa origem
                const x = easting - 500000; // falsa origem leste
                
                // Para o Brasil (hemisf√©rio sul), n√£o temos falsa origem no northing
                // Mas vamos verificar se est√° no hemisf√©rio sul (northing < 10,000,000)
                const y = northing;
                
                // Calcular longitude do meridiano central do fuso
                const lon0 = (zone - 1) * 6 - 180 + 3;
                
                // Calcular M (dist√¢ncia ao longo do meridiano desde o equador)
                const M = y / k0;
                
                // Calcular mu (par√¢metro auxiliar)
                const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
                
                // Calcular latitude de refer√™ncia (footprint latitude)
                const lat1 = mu + (3*e1/2 - 27*e1*e1*e1/32) * Math.sin(2*mu) +
                            (21*e1*e1/16 - 55*e1*e1*e1*e1/32) * Math.sin(4*mu) +
                            (151*e1*e1*e1/96) * Math.sin(6*mu) +
                            (1097*e1*e1*e1*e1/512) * Math.sin(8*mu);
                
                // Calcular constantes auxiliares
                const N1 = a / Math.sqrt(1 - e2 * Math.sin(lat1) * Math.sin(lat1));
                const T1 = Math.tan(lat1) * Math.tan(lat1);
                const C1 = e2 * Math.cos(lat1) * Math.cos(lat1) / (1 - e2);
                const R1 = a * (1 - e2) / Math.pow(1 - e2 * Math.sin(lat1) * Math.sin(lat1), 1.5);
                const D = x / (N1 * k0);
                
                // Calcular latitude final
                const lat = lat1 - (N1 * Math.tan(lat1) / (k0 * R1)) * (
                    D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*e2) * D*D*D*D/24 +
                    (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*e2 - 3*C1*C1) * D*D*D*D*D*D/720
                );
                
                // Calcular longitude final
                const lon = lon0 + (
                    D - (1 + 2*T1 + C1) * D*D*D/6 +
                    (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*e2 + 24*T1*T1) * D*D*D*D*D/120
                ) / Math.cos(lat1);
                
                const latDeg = lat * 180 / Math.PI;
                const lonDeg = lon * 180 / Math.PI;
                
                // Valida√ß√£o b√°sica para coordenadas do Brasil
                if (latDeg < -35 || latDeg > 5 || lonDeg < -75 || lonDeg > -28) {
                    console.warn('Coordenadas fora dos limites esperados para o Brasil:', latDeg, lonDeg);
                }
                
                return {
                    lat: latDeg,
                    lon: lonDeg
                };
            } catch (error) {
                console.error('Erro na convers√£o UTM:', error, 'Coords:', easting, northing, zone);
                return null;
            }
        }

        // Carregar dados da API
        async function loadData() {
            try {
                // Adiciona timestamp para evitar cache
                const timestamp = new Date().getTime();
                const response = await fetch(`http://localhost:5000/api/projects?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('Dados carregados da API em:', new Date().toLocaleString());
                console.log('Registros encontrados:', data.length);
                
                // Processa os dados da API (j√° vem no formato correto)
                projetosData = data.map((projeto, index) => {
                    // Garante ID √∫nico
                    projeto.id = projeto.id || `projeto-${index}`;
                    return projeto;
                });

                projetosFiltrados = [...projetosData];
                renderProjects();
            } catch (error) {
                console.error('Erro ao carregar dados da API:', error);
                
                // Tenta carregar do JSON como fallback
                console.log('Tentando carregar do JSON como fallback...');
                try {
                    const timestamp = new Date().getTime();
                    const response = await fetch(`planilha_portos.json?t=${timestamp}`);
                    const jsonData = await response.json();
                    
                    console.log('Dados carregados do JSON em:', new Date().toLocaleString());
                    console.log('Registros encontrados:', jsonData['Tabela 00 - Cadastro']?.length || 0);
                    
                    const cadastros = jsonData['Tabela 00 - Cadastro'] || [];
                    const servicos = jsonData['Tabela 01 - Servi√ßos'] || [];
                    const acompanhamentos = jsonData['Tabela 02 - Acompanhamento'] || [];

                    // Processar projetos (mant√©m l√≥gica original)
                    projetosData = cadastros.map((cadastro, index) => {
                        const projetoId = `projeto-${index}`;
                        const zona = cadastro['Zona portu√°ria'] || 'N√£o informado';
                        const obj = cadastro['Obj. de Concess√£o'] || '';
                        const nomeProjeto = zona === 'N√£o se aplica' ? obj : `${zona} - ${obj}`;

                        // Buscar servi√ßos relacionados
                        const servicosProjeto = servicos.filter(s => 
                            s['Zona portu√°ria'] === cadastro['Zona portu√°ria'] &&
                            s['UF'] === cadastro['UF'] &&
                            s['Obj. de Concess√£o'] === cadastro['Obj. de Concess√£o']
                        );

                        // Buscar acompanhamentos relacionados
                        const acompanhamentosProjeto = acompanhamentos.filter(a => 
                            a['Zona portu√°ria'] === cadastro['Zona portu√°ria'] &&
                            a['UF'] === cadastro['UF'] &&
                            a['Obj. de Concess√£o'] === cadastro['Obj. de Concess√£o']
                        );

                        // Calcular progresso baseado no acompanhamento mais recente
                        let progresso = 0;
                        if (acompanhamentosProjeto.length > 0) {
                            const maisRecente = acompanhamentosProjeto.sort((a, b) => {
                                const dataA = new Date(a['Data da atualiza√ß√£o'] || 0);
                                const dataB = new Date(b['Data da atualiza√ß√£o'] || 0);
                                return dataB - dataA;
                            })[0];
                            progresso = (maisRecente['% executada'] || 0) * 100;
                        }

                        // ETAPA baseada no status dos servi√ßos
                        let etapa = 'Planejamento';
                        const servicosEmExecucao = servicosProjeto.filter(s => {
                            if (!s['Data de in√≠cio'] || !s['Data final']) return false;
                            const inicio = new Date(s['Data de in√≠cio']);
                            const fim = new Date(s['Data final']);
                            const hoje = new Date();
                            return hoje >= inicio && hoje <= fim;
                        });
                        if (servicosEmExecucao.length > 0) {
                            etapa = `Execu√ß√£o - ${servicosEmExecucao.length} servi√ßo(s) em andamento`;
                        } else if (progresso > 0) {
                            etapa = 'Em execu√ß√£o';
                        }

                        // Mapa - converter coordenadas se dispon√≠vel
                        let mapaEmbed = null;
                        let coordenadasLatLon = null;
                        
                        // Verifica se j√° tem Lat/Lon direto ou precisa converter UTM
                        if (cadastro['Latitude'] && cadastro['Longitude']) {
                            // Usa coordenadas diretas (Lat/Lon)
                            coordenadasLatLon = {
                                lat: parseFloat(cadastro['Latitude']),
                                lon: parseFloat(cadastro['Longitude'])
                            };
                            console.log(`Usando coordenadas diretas para ${nomeProjeto}:`, coordenadasLatLon);
                        } else if (cadastro['Coordenada E (UTM)'] && cadastro['Coordenada S (UTM)'] && cadastro['Fuso']) {
                            // Converte de UTM para Lat/Lon
                            const coordE = parseFloat(cadastro['Coordenada E (UTM)']);
                            const coordS = parseFloat(cadastro['Coordenada S (UTM)']);
                            const fuso = parseInt(cadastro['Fuso']);
                            
                            console.log(`Convertendo coordenadas UTM para ${nomeProjeto}:`, {coordE, coordS, fuso});
                            
                            const latLon = utmToLatLon(coordE, coordS, fuso);
                            if (latLon && !isNaN(latLon.lat) && !isNaN(latLon.lon)) {
                                coordenadasLatLon = latLon;
                                console.log(`Coordenadas convertidas para ${nomeProjeto}:`, latLon);
                            } else {
                                console.warn(`Falha na convers√£o de coordenadas UTM para ${nomeProjeto}:`, latLon);
                            }
                        } else {
                            console.log(`Coordenadas n√£o dispon√≠veis para ${nomeProjeto}:`, {
                                latitude: cadastro['Latitude'],
                                longitude: cadastro['Longitude'],
                                easting: cadastro['Coordenada E (UTM)'],
                                northing: cadastro['Coordenada S (UTM)'],
                                zone: cadastro['Fuso']
                            });
                        }
                        
                        // Gera o mapa se tiver coordenadas v√°lidas
                        if (coordenadasLatLon && !isNaN(coordenadasLatLon.lat) && !isNaN(coordenadasLatLon.lon)) {
                            // Usar OpenStreetMap com bounding box adequada
                            const bboxSize = 0.02; // ~2km de bbox
                            const bbox = `${coordenadasLatLon.lon-bboxSize},${coordenadasLatLon.lat-bboxSize},${coordenadasLatLon.lon+bboxSize},${coordenadasLatLon.lat+bboxSize}`;
                            
                            mapaEmbed = `
                                <div class="w-full h-full relative">
                                    <iframe 
                                        width="100%" 
                                        height="100%" 
                                        style="border:0; border-radius: 8px;" 
                                        src="https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${coordenadasLatLon.lat},${coordenadasLatLon.lon}" 
                                        frameborder="0"
                                        allowfullscreen>
                                    </iframe>
                                    <div class="absolute bottom-2 left-2 bg-white bg-opacity-90 px-2 py-1 rounded text-xs text-gray-700">
                                        üìç ${coordenadasLatLon.lat.toFixed(6)}, ${coordenadasLatLon.lon.toFixed(6)}
                                    </div>
                                </div>
                            `;
                        }

                        return {
                            id: projetoId,
                            nome: nomeProjeto,
                            zona: zona,
                            uf: cadastro['UF'] || '',
                            objConcessao: obj,
                            tipo: cadastro['Tipo'] || '',
                            capexTotal: cadastro['CAPEX Total'] || 0,
                            dataAssinatura: cadastro['Data de assinatura do contrato'] || null,
                            descricao: cadastro['Descri√ß√£o'] || 'Sem descri√ß√£o dispon√≠vel',
                            progresso: progresso,
                            etapa: etapa,
                            servicos: servicosProjeto,
                            acompanhamentos: acompanhamentosProjeto,
                            mapaEmbed: mapaEmbed,
                            coordenadas: {
                                e: cadastro['Coordenada E (UTM)'],
                                s: cadastro['Coordenada S (UTM)'],
                                fuso: cadastro['Fuso'],
                                latitude: cadastro['Latitude'],
                                longitude: cadastro['Longitude']
                            },
                            coordenadasLatLon: coordenadasLatLon
                        };
                    });

                    projetosFiltrados = [...projetosData];
                    renderProjects();
                    console.log('Dados carregados do JSON com sucesso!');
                } catch (jsonError) {
                    console.error('Erro ao carregar do JSON:', jsonError);
                    document.getElementById('projects-grid').innerHTML = 
                        '<div class="col-span-full text-center text-white p-8"><p>Erro ao carregar dados. Verifique se o servidor est√° rodando ou o arquivo JSON est√° dispon√≠vel.</p></div>';
                }
            }
        }

        // Renderizar cards de projetos
        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            
            if (projetosFiltrados.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-white p-8"><p>Nenhum projeto encontrado.</p></div>';
                return;
            }

            grid.innerHTML = projetosFiltrados.map(projeto => {
                const statusColor = projeto.progresso === 0 ? 'bg-gray-400' : 
                                   projeto.progresso < 50 ? 'bg-yellow-500' : 
                                   projeto.progresso < 100 ? 'bg-blue-500' : 'bg-green-500';
                
                return `
                    <div data-id="${projeto.id}" class="project-card bg-white rounded-xl shadow-md p-6 cursor-pointer">
                        <div>
                            <p class="text-sm text-gray-500">${projeto.uf} ‚Ä¢ ${projeto.tipo || 'N/A'}</p>
                            <h3 class="text-lg font-bold mt-1 text-gray-800">${projeto.nome}</h3>
                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">${projeto.descricao}</p>
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full ${statusColor} mr-2"></span>
                                <span class="text-sm font-medium text-gray-600">${projeto.etapa}</span>
                            </div>
                            ${projeto.capexTotal > 0 ? `
                                <span class="text-xs text-gray-500">
                                    R$ ${(projeto.capexTotal / 1000000).toFixed(1)}M
                                </span>
                            ` : ''}
                        </div>
                        ${projeto.progresso > 0 ? `
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${projeto.progresso}%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${projeto.progresso.toFixed(1)}% conclu√≠do</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Renderizar detalhes do projeto no modal
        async function renderProjectDetails(projectId) {
            try {
                // Extrai ID num√©rico do ID do frontend (ex: "projeto-541" -> 541)
                const numericId = projectId.replace('projeto-', '');
                
                // Carrega dados completos do projeto
                const response = await fetch(`/api/projects`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar detalhes do projeto');
                }
                
                const allProjects = await response.json();
                currentProject = allProjects.find(p => p.id === projectId);
                
                if (!currentProject) {
                    throw new Error('Projeto n√£o encontrado');
                }
                
                const modal = document.getElementById('project-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                
                // Reset modo de edi√ß√£o
                isEditMode = false;
                const editBtn = document.getElementById('edit-project-btn');
                const editBtnText = document.getElementById('edit-btn-text');
                editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                editBtnText.textContent = 'Editar Acompanhamento';
                
                // Configura t√≠tulo
                const zona = currentProject.zona || 'N√£o informado';
                const obj = currentProject.objConcessao || '';
                const nomeProjeto = zona === 'N√£o se aplica' ? obj : `${zona} - ${obj}`;
                modalTitle.textContent = nomeProjeto;
                
                // Renderiza modo visualiza√ß√£o
                modalBody.innerHTML = `
                    <div class="modal-info-grid">
                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="bg-gray-50 rounded-xl p-6 card--descricao">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-info-circle text-blue-600"></i>
                                Informa√ß√µes do Projeto
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Zona Portu√°ria:</span>
                                    <span class="text-gray-800 ml-2">${currentProject.zona || 'N√£o se aplica'}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">UF:</span>
                                    <span class="text-gray-800 ml-2">${currentProject.uf || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Objeto de Concess√£o:</span>
                                    <span class="text-gray-800 ml-2">${currentProject.objConcessao || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Tipo:</span>
                                    <span class="text-gray-800 ml-2">${currentProject.tipo || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">CAPEX Total:</span>
                                    <span class="text-gray-800 ml-2">R$ ${formatCurrency(currentProject.capexTotal || 0)}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Data Assinatura:</span>
                                    <span class="text-gray-800 ml-2">${formatDate(currentProject.dataAssinatura) || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-600">Descri√ß√£o:</span>
                                    <p class="text-gray-800 mt-1">${currentProject.descricao || 'N√£o informada'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Mapa -->
                        <div class="bg-gray-50 rounded-xl p-6 card--mapa">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-blue-600"></i>
                                Localiza√ß√£o
                            </h3>
                            ${generateMapEmbed(currentProject)}
                        </div>

                        <!-- Acompanhamento -->
                        <div class="bg-gray-50 rounded-xl p-6 card--etapa">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-chart-line text-blue-600"></i>
                                Tabela 02 - Acompanhamento
                            </h3>
                            ${renderAcompanhamentos()}
                        </div>
                    </div>
                `;
                
                // Mostra modal
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                setTimeout(() => {
                    document.getElementById('modal-content').classList.add('modal-enter');
                }, 10);
                
            } catch (error) {
                console.error('Erro ao renderizar detalhes do projeto:', error);
                showToast('error', 'Erro!', 'Falha ao carregar detalhes do projeto');
            }
        }

        function renderAcompanhamentos() {
            if (!currentProject.acompanhamentos || currentProject.acompanhamentos.length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhum acompanhamento cadastrado</p>';
            }
            
            return currentProject.acompanhamentos.map((acompanhamento, index) => `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-gray-800">Acompanhamento ${index + 1}</h4>
                        <span class="text-xs text-gray-500">${formatDate(acompanhamento.data_atualizacao)}</span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">Fase:</span>
                            <span class="text-gray-800 ml-1">${acompanhamento.fase || '-'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Servi√ßo:</span>
                            <span class="text-gray-800 ml-1">${acompanhamento.servico || '-'}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">% Executada:</span>
                            <span class="text-gray-800 ml-1">${acompanhamento.percentual_executada || 0}%</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Valor Executado:</span>
                            <span class="text-gray-800 ml-1">R$ ${formatCurrency(acompanhamento.valor_executado || 0)}</span>
                        </div>
                    </div>
                    
                    ${acompanhamento.descricao ? `
                        <div class="mt-2">
                            <span class="font-medium text-gray-600 text-sm">Descri√ß√£o:</span>
                            <p class="text-gray-800 text-sm mt-1">${acompanhamento.descricao}</p>
                        </div>
                    ` : ''}
                    
                    ${acompanhamento.responsavel ? `
                        <div class="mt-2">
                            <span class="font-medium text-gray-600 text-sm">Respons√°vel:</span>
                            <span class="text-gray-800 text-sm ml-1">${acompanhamento.responsavel}</span>
                            ${acompanhamento.cargo ? `(${acompanhamento.cargo})` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function generateMapEmbed(projeto) {
            if (!projeto.coordenadas || !projeto.coordenadas.latitude || !projeto.coordenadas.longitude) {
                return `
                    <div class="text-center py-8">
                        <i class="fas fa-map-marked-alt text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Coordenadas n√£o dispon√≠veis</p>
                        ${projeto.coordenadas && projeto.coordenadas.e && projeto.coordenadas.s ? `
                            <p class="text-sm text-gray-400 mt-2">
                                UTM: E=${projeto.coordenadas.e}, S=${projeto.coordenadas.s}, Fuso=${projeto.coordenadas.fuso}
                            </p>
                        ` : ''}
                    </div>
                `;
            }
            
            const lat = projeto.coordenadas.latitude;
            const lon = projeto.coordenadas.longitude;
            const bboxSize = 0.02;
            
            return `
                <div class="space-y-3">
                    <div class="bg-blue-50 rounded-lg p-3">
                        <p class="text-sm font-medium text-blue-800">
                            <i class="fas fa-location-dot mr-1"></i>
                            Coordenadas: ${lat.toFixed(6)}, ${lon.toFixed(6)}
                        </p>
                    </div>
                    <iframe 
                        width="100%" 
                        height="300" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-bboxSize},${lat-bboxSize},${lon+bboxSize},${lat+bboxSize}&layer=mapnik&marker=${lat},${lon}">
                    </iframe>
                    <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=15/${lat}/${lon}" 
                       target="_blank" 
                       class="text-blue-600 hover:text-blue-800 text-sm underline">
                        <i class="fas fa-external-link-alt mr-1"></i>
                        Ver no OpenStreetMap
                    </a>
                </div>
            `;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Event listeners
        document.getElementById('reload-btn').addEventListener('click', async () => {
            const btn = document.getElementById('reload-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
            btn.disabled = true;
            
            try {
                await loadData();
                console.log('Dados recarregados com sucesso!');
            } catch (error) {
                console.error('Erro ao recarregar dados:', error);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            projetosFiltrados = projetosData.filter(projeto => 
                projeto.nome.toLowerCase().includes(searchTerm) ||
                projeto.descricao.toLowerCase().includes(searchTerm) ||
                projeto.uf.toLowerCase().includes(searchTerm) ||
                projeto.zona.toLowerCase().includes(searchTerm)
            );
            renderProjects();
        });

        document.getElementById('projects-grid').addEventListener('click', (e) => {
            const card = e.target.closest('.project-card');
            if (card && card.dataset.id) {
                renderProjectDetails(card.dataset.id);
            }
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            const modal = document.getElementById('project-modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex', 'modal-enter', 'modal-leave');
            }, 300);
        });

        document.getElementById('project-modal').addEventListener('click', (e) => {
            if (e.target.id === 'project-modal') {
                const modal = document.getElementById('project-modal');
                const modalContent = document.getElementById('modal-content');
                modalContent.classList.add('modal-leave');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex', 'modal-enter', 'modal-leave');
                }, 300);
            }
        });

        // Carregar dados ao iniciar
        loadData();

        // Fun√ß√µes de Edi√ß√£o Inline
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('edit-project-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            
            if (isEditMode) {
                editBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                editBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                editBtnText.textContent = 'Salvar Acompanhamento';
                renderAcompanhamentoEditMode();
            } else {
                editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                editBtnText.textContent = 'Editar Acompanhamento';
                saveAcompanhamentoChanges();
            }
        }

        function renderAcompanhamentoEditMode() {
            if (!currentProject) return;
            
            const modalBody = document.getElementById('modal-body');
            
            // Encontra a se√ß√£o de acompanhamento e substitui por tabela edit√°vel
            const acompanhamentoSection = modalBody.querySelector('.card--etapa');
            if (acompanhamentoSection) {
                acompanhamentoSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-edit text-yellow-500"></i>
                        Editar Tabela 02 - Acompanhamento
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                Edite diretamente os dados da Tabela 02 - Acompanhamento do projeto
                            </p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">Fase</th>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">Servi√ßo</th>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">% Executada</th>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">Valor Executado</th>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">Data</th>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">Respons√°vel</th>
                                        <th class="border border-gray-300 px-2 py-1 text-xs">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="acompanhamento-tbody">
                                    ${renderAcompanhamentoRows()}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="addAcompanhamentoRow()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-plus mr-1"></i> Adicionar Linha
                            </button>
                            <button onclick="cancelAcompanhamentoEdit()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button onclick="toggleEditMode()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-save mr-2"></i>Salvar Altera√ß√µes
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderAcompanhamentoRows() {
            if (!currentProject.acompanhamentos || currentProject.acompanhamentos.length === 0) {
                return `
                    <tr>
                        <td colspan="7" class="border border-gray-300 px-2 py-4 text-center text-gray-500">
                            Nenhum acompanhamento cadastrado
                        </td>
                    </tr>
                `;
            }
            
            return currentProject.acompanhamentos.map((acompanhamento, index) => `
                <tr>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${acompanhamento.fase || ''}" 
                               id="fase-${index}"
                               class="w-full px-1 py-1 text-xs border-0 focus:ring-1 focus:ring-yellow-500"
                               placeholder="Fase">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${acompanhamento.servico || ''}" 
                               id="servico-${index}"
                               class="w-full px-1 py-1 text-xs border-0 focus:ring-1 focus:ring-yellow-500"
                               placeholder="Servi√ßo">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${acompanhamento.percentual_executada || 0}" 
                               id="percentual-${index}"
                               class="w-full px-1 py-1 text-xs border-0 focus:ring-1 focus:ring-yellow-500"
                               step="0.01" min="0" max="100">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="number" value="${acompanhamento.valor_executado || 0}" 
                               id="valor-${index}"
                               class="w-full px-1 py-1 text-xs border-0 focus:ring-1 focus:ring-yellow-500"
                               step="0.01">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="date" value="${acompanhamento.data_atualizacao || ''}" 
                               id="data-${index}"
                               class="w-full px-1 py-1 text-xs border-0 focus:ring-1 focus:ring-yellow-500">
                    </td>
                    <td class="border border-gray-300 px-2 py-1">
                        <input type="text" value="${acompanhamento.responsavel || ''}" 
                               id="responsavel-${index}"
                               class="w-full px-1 py-1 text-xs border-0 focus:ring-1 focus:ring-yellow-500"
                               placeholder="Respons√°vel">
                    </td>
                    <td class="border border-gray-300 px-2 py-1 text-center">
                        <button onclick="removeAcompanhamentoRow(${index})" class="text-red-500 hover:text-red-700 text-xs">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function addAcompanhamentoRow() {
            if (!currentProject.acompanhamentos) {
                currentProject.acompanhamentos = [];
            }
            
            const novoAcompanhamento = {
                id: Date.now(),
                projeto_id: currentProject.id,
                fase: '',
                servico: '',
                descricao: '',
                percentual_executada: 0,
                valor_executado: 0,
                data_atualizacao: new Date().toISOString().split('T')[0],
                responsavel: '',
                cargo: '',
                setor: '',
                riscos_tipo: '',
                riscos_descricao: ''
            };
            
            currentProject.acompanhamentos.push(novoAcompanhamento);
            
            // Atualiza a tabela
            const tbody = document.getElementById('acompanhamento-tbody');
            if (tbody) {
                tbody.innerHTML = renderAcompanhamentoRows();
            }
        }

        function removeAcompanhamentoRow(index) {
            if (!currentProject.acompanhamentos) return;
            
            currentProject.acompanhamentos.splice(index, 1);
            
            // Atualiza a tabela
            const tbody = document.getElementById('acompanhamento-tbody');
            if (tbody) {
                tbody.innerHTML = renderAcompanhamentoRows();
            }
        }

        function cancelAcompanhamentoEdit() {
            isEditMode = false;
            const editBtn = document.getElementById('edit-project-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            editBtnText.textContent = 'Editar Acompanhamento';
            
            // Recarrega o modal no modo visualiza√ß√£o
            renderProjectDetails(currentProject.id);
        }

        async function saveAcompanhamentoChanges() {
            if (!currentProject) return;
            
            try {
                // Coleta os dados da tabela
                const acompanhamentosAtualizados = [];
                
                if (currentProject.acompanhamentos && currentProject.acompanhamentos.length > 0) {
                    currentProject.acompanhamentos.forEach((acompanhamento, index) => {
                        const faseInput = document.getElementById(`fase-${index}`);
                        const servicoInput = document.getElementById(`servico-${index}`);
                        const percentualInput = document.getElementById(`percentual-${index}`);
                        const valorInput = document.getElementById(`valor-${index}`);
                        const dataInput = document.getElementById(`data-${index}`);
                        const responsavelInput = document.getElementById(`responsavel-${index}`);
                        
                        if (faseInput) {
                            acompanhamentosAtualizados.push({
                                ...acompanhamento,
                                fase: faseInput.value,
                                servico: servicoInput ? servicoInput.value : '',
                                percentual_executada: parseFloat(percentualInput ? percentualInput.value : 0),
                                valor_executado: parseFloat(valorInput ? valorInput.value : 0),
                                data_atualizacao: dataInput ? dataInput.value : '',
                                responsavel: responsavelInput ? responsavelInput.value : ''
                            });
                        }
                    });
                }
                
                // Salva cada acompanhamento
                for (const acompanhamento of acompanhamentosAtualizados) {
                    if (acompanhamento.id && acompanhamento.id.toString().length < 13) {
                        // ID tempor√°rio, criar novo
                        await fetch('/api/acompanhamento', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...acompanhamento,
                                projeto_id: currentProject.id
                            })
                        });
                    } else {
                        // ID existente, atualizar
                        await fetch(`/api/acompanhamento/${acompanhamento.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(acompanhamento)
                        });
                    }
                }
                
                // Mostra sucesso
                showToast('success', 'Sucesso!', 'Acompanhamento atualizado com sucesso!');
                
                // Recarrega dados
                await loadData();
                
                // Volta para modo visualiza√ß√£o
                isEditMode = false;
                const editBtn = document.getElementById('edit-project-btn');
                const editBtnText = document.getElementById('edit-btn-text');
                editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                editBtnText.textContent = 'Editar Acompanhamento';
                
                // Renderiza modo visualiza√ß√£o
                renderProjectDetails(currentProject.id);
                
            } catch (error) {
                console.error('Erro ao salvar acompanhamento:', error);
                showToast('error', 'Erro!', 'Falha ao salvar altera√ß√µes do acompanhamento');
            }
        }

        function renderEditMode() {
            if (!currentProject) return;
            
            const modalBody = document.getElementById('modal-body');
            
            // Renderiza formul√°rio de edi√ß√£o
            modalBody.innerHTML = `
                <div class="space-y-6">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-edit text-yellow-500"></i>
                            Editar Informa√ß√µes do Projeto
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zona Portu√°ria</label>
                                <input type="text" id="edit-zona" value="${currentProject.zona_portuaria || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">UF</label>
                                <input type="text" id="edit-uf" value="${currentProject.uf || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Objeto de Concess√£o</label>
                                <input type="text" id="edit-obj" value="${currentProject.obj_concessao || ''}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CAPEX Total</label>
                                <input type="number" id="edit-capex" value="${currentProject.capex_total || 0}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                            <textarea id="edit-descricao" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">${currentProject.descricao || ''}</textarea>
                        </div>
                    </div>

                    <!-- Acompanhamentos -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-chart-line text-yellow-500"></i>
                                Acompanhamento do Projeto
                            </h3>
                            <button onclick="addAcompanhamento()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">
                                <i class="fas fa-plus mr-1"></i> Adicionar
                            </button>
                        </div>
                        
                        <div id="acompanhamentos-list" class="space-y-3">
                            ${renderAcompanhamentosEdit()}
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex gap-3 justify-end">
                        <button onclick="cancelEdit()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                            Cancelar
                        </button>
                        <button onclick="toggleEditMode()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-save mr-2"></i>Salvar Altera√ß√µes
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAcompanhamentosEdit() {
            if (!currentProject.acompanhamentos || currentProject.acompanhamentos.length === 0) {
                return '<p class="text-gray-500 text-center py-4">Nenhum acompanhamento cadastrado</p>';
            }
            
            return currentProject.acompanhamentos.map((acompanhamento, index) => `
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-800">Acompanhamento ${index + 1}</h4>
                        <button onclick="removeAcompanhamento(${acompanhamento.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Fase</label>
                            <input type="text" value="${acompanhamento.fase || ''}" 
                                   onchange="updateAcompanhamento(${acompanhamento.id}, 'fase', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Servi√ßo</label>
                            <input type="text" value="${acompanhamento.servico || ''}" 
                                   onchange="updateAcompanhamento(${acompanhamento.id}, 'servico', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">% Executada</label>
                            <input type="number" value="${acompanhamento.percentual_executada || 0}" 
                                   onchange="updateAcompanhamento(${acompanhamento.id}, 'percentual_executada', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500" step="0.01" min="0" max="100">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Valor Executado</label>
                            <input type="number" value="${acompanhamento.valor_executado || 0}" 
                                   onchange="updateAcompanhamento(${acompanhamento.id}, 'valor_executado', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500" step="0.01">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Data Atualiza√ß√£o</label>
                            <input type="date" value="${acompanhamento.data_atualizacao || ''}" 
                                   onchange="updateAcompanhamento(${acompanhamento.id}, 'data_atualizacao', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Respons√°vel</label>
                            <input type="text" value="${acompanhamento.responsavel || ''}" 
                                   onchange="updateAcompanhamento(${acompanhamento.id}, 'responsavel', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Descri√ß√£o</label>
                        <textarea rows="2" onchange="updateAcompanhamento(${acompanhamento.id}, 'descricao', this.value)"
                                  class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-yellow-500">${acompanhamento.descricao || ''}</textarea>
                    </div>
                </div>
            `).join('');
        }

        function updateAcompanhamento(id, field, value) {
            if (!currentProject.acompanhamentos) return;
            
            const acompanhamento = currentProject.acompanhamentos.find(a => a.id === id);
            if (acompanhamento) {
                acompanhamento[field] = value;
            }
        }

        function addAcompanhamento() {
            if (!currentProject.acompanhamentos) {
                currentProject.acompanhamentos = [];
            }
            
            const novoAcompanhamento = {
                id: Date.now(), // ID tempor√°rio
                projeto_id: currentProject.id,
                fase: '',
                servico: '',
                descricao: '',
                percentual_executada: 0,
                valor_executado: 0,
                data_atualizacao: new Date().toISOString().split('T')[0],
                responsavel: '',
                cargo: '',
                setor: '',
                riscos_tipo: '',
                riscos_descricao: ''
            };
            
            currentProject.acompanhamentos.push(novoAcompanhamento);
            
            // Atualiza a lista
            const acompanhamentosList = document.getElementById('acompanhamentos-list');
            if (acompanhamentosList) {
                acompanhamentosList.innerHTML = renderAcompanhamentosEdit();
            }
        }

        function removeAcompanhamento(id) {
            if (!currentProject.acompanhamentos) return;
            
            currentProject.acompanhamentos = currentProject.acompanhamentos.filter(a => a.id !== id);
            
            // Atualiza a lista
            const acompanhamentosList = document.getElementById('acompanhamentos-list');
            if (acompanhamentosList) {
                acompanhamentosList.innerHTML = renderAcompanhamentosEdit();
            }
        }

        async function saveChanges() {
            if (!currentProject) return;
            
            try {
                // Prepara dados do projeto
                const projectData = {
                    zona_portuaria: document.getElementById('edit-zona').value,
                    uf: document.getElementById('edit-uf').value,
                    obj_concessao: document.getElementById('edit-obj').value,
                    capex_total: parseFloat(document.getElementById('edit-capex').value) || 0,
                    descricao: document.getElementById('edit-descricao').value
                };
                
                // Atualiza projeto
                const projectResponse = await fetch(`/api/projects/${currentProject.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(projectData)
                });
                
                if (!projectResponse.ok) {
                    throw new Error('Erro ao atualizar projeto');
                }
                
                // Salva acompanhamentos
                for (const acompanhamento of currentProject.acompanhamentos) {
                    if (acompanhamento.id && acompanhamento.id.toString().length < 13) {
                        // ID tempor√°rio, criar novo
                        await fetch('/api/acompanhamento', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...acompanhamento,
                                projeto_id: currentProject.id
                            })
                        });
                    } else {
                        // ID existente, atualizar
                        await fetch(`/api/acompanhamento/${acompanhamento.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(acompanhamento)
                        });
                    }
                }
                
                // Mostra sucesso
                showToast('success', 'Sucesso!', 'Projeto atualizado com sucesso!');
                
                // Recarrega dados
                await loadData();
                
                // Volta para modo visualiza√ß√£o
                isEditMode = false;
                const editBtn = document.getElementById('edit-project-btn');
                const editBtnText = document.getElementById('edit-btn-text');
                editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                editBtnText.textContent = 'Alterar Andamento';
                
                // Renderiza modo visualiza√ß√£o
                renderProjectDetails(currentProject.id);
                
            } catch (error) {
                console.error('Erro ao salvar altera√ß√µes:', error);
                showToast('error', 'Erro!', 'Falha ao salvar altera√ß√µes');
            }
        }

        function cancelEdit() {
            isEditMode = false;
            const editBtn = document.getElementById('edit-project-btn');
            const editBtnText = document.getElementById('edit-btn-text');
            editBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            editBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            editBtnText.textContent = 'Alterar Andamento';
            
            // Renderiza modo visualiza√ß√£o
            renderProjectDetails(currentProject.id);
        }

        function showToast(type, title, message) {
            // Cria toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 z-50 bg-white rounded-lg shadow-xl p-4 flex items-center gap-3 min-w-[300px]';
            toast.innerHTML = `
                <div class="${type === 'success' ? 'text-green-500' : 'text-red-500'}">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-xl"></i>
                </div>
                <div>
                    <p class="text-gray-800 font-medium">${title}</p>
                    <p class="text-sm text-gray-600">${message}</p>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
