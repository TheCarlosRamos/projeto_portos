<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Concess√µes Portu√°rias - Apresenta√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #2E4E8C;
            --primary-dark: #243B6B;
            --primary-light: #3E5FA4;
            --accent-green: #2E7D32;
            --accent-yellow: #F7B500;
            --accent-red: #C62828;
        }

        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: #4A4A4A;
            font-family: 'Inter', sans-serif;
        }

        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .project-card {
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        .project-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .modal-info-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .nav-item {
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: white;
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        @media (min-width: 1024px) {
            .modal-info-grid {
                grid-template-areas:
                    'descricao mapa'
                    'etapa mapa';
                grid-template-columns: 1fr 1fr;
            }
            .card--descricao { grid-area: descricao; }
            .card--mapa { grid-area: mapa; }
            .card--etapa { grid-area: etapa; }
        }
    </style>
</head>
<body>
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-64 h-full shadow-xl">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <i class="fas fa-ship text-2xl text-blue-600"></i>
                    <h1 class="text-xl font-bold text-gray-800">Sistema Portu√°rio</h1>
                </div>
                
                <nav class="space-y-2">
                    <a href="/" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700">
                        <i class="fas fa-dashboard"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/cadastro" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700">
                        <i class="fas fa-plus-circle"></i>
                        <span>Cadastro</span>
                    </a>
                    <a href="/planilhas" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700">
                        <i class="fas fa-file-excel"></i>
                        <span>Planilhas</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto">
            <div class="min-h-screen pb-12">
                <!-- Header -->
                <div class="bg-white shadow-md">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gest√£o de Concess√µes Portu√°rias</h1>
                        <p class="text-gray-600 mt-2">Acompanhamento de Projetos de Concess√£o</p>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Search and Filter -->
            <div class="mb-6 flex gap-4">
                <div class="relative flex-1">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="search-input" 
                           class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Buscar projetos...">
                </div>
                <button id="reload-btn" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    Recarregar Dados
                </button>
            </div>

            <!-- Projects Grid -->
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards ser√£o inseridos aqui via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-[95vw] max-w-7xl max-h-[90vh] overflow-y-auto relative transform transition-all duration-300">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div id="modal-body" class="p-8 md:p-12">
                <!-- Conte√∫do ser√° inserido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let projetosData = [];
        let projetosFiltrados = [];

        // Fun√ß√£o para converter UTM para Lat/Lon (WGS84)
        function utmToLatLon(easting, northing, zone) {
            try {
                // Par√¢metros do elipsoide WGS84
                const a = 6378137.0; // semi-eixo maior (metros)
                const f = 1 / 298.257223563; // achatamento
                const e2 = 2 * f - f * f; // primeira excentricidade ao quadrado
                const k0 = 0.9996; // fator de escala
                
                // Constantes
                const e1 = (1 - Math.sqrt(1 - e2)) / (1 + Math.sqrt(1 - e2));
                
                // Remover falsa origem
                const x = easting - 500000; // falsa origem leste
                
                // Para o Brasil (hemisf√©rio sul), n√£o temos falsa origem no northing
                // Mas vamos verificar se est√° no hemisf√©rio sul (northing < 10,000,000)
                const y = northing;
                
                // Calcular longitude do meridiano central do fuso
                const lon0 = (zone - 1) * 6 - 180 + 3;
                
                // Calcular M (dist√¢ncia ao longo do meridiano desde o equador)
                const M = y / k0;
                
                // Calcular mu (par√¢metro auxiliar)
                const mu = M / (a * (1 - e2/4 - 3*e2*e2/64 - 5*e2*e2*e2/256));
                
                // Calcular latitude de refer√™ncia (footprint latitude)
                const lat1 = mu + (3*e1/2 - 27*e1*e1*e1/32) * Math.sin(2*mu) +
                            (21*e1*e1/16 - 55*e1*e1*e1*e1/32) * Math.sin(4*mu) +
                            (151*e1*e1*e1/96) * Math.sin(6*mu) +
                            (1097*e1*e1*e1*e1/512) * Math.sin(8*mu);
                
                // Calcular constantes auxiliares
                const N1 = a / Math.sqrt(1 - e2 * Math.sin(lat1) * Math.sin(lat1));
                const T1 = Math.tan(lat1) * Math.tan(lat1);
                const C1 = e2 * Math.cos(lat1) * Math.cos(lat1) / (1 - e2);
                const R1 = a * (1 - e2) / Math.pow(1 - e2 * Math.sin(lat1) * Math.sin(lat1), 1.5);
                const D = x / (N1 * k0);
                
                // Calcular latitude final
                const lat = lat1 - (N1 * Math.tan(lat1) / (k0 * R1)) * (
                    D*D/2 - (5 + 3*T1 + 10*C1 - 4*C1*C1 - 9*e2) * D*D*D*D/24 +
                    (61 + 90*T1 + 298*C1 + 45*T1*T1 - 252*e2 - 3*C1*C1) * D*D*D*D*D*D/720
                );
                
                // Calcular longitude final
                const lon = lon0 + (
                    D - (1 + 2*T1 + C1) * D*D*D/6 +
                    (5 - 2*C1 + 28*T1 - 3*C1*C1 + 8*e2 + 24*T1*T1) * D*D*D*D*D/120
                ) / Math.cos(lat1);
                
                const latDeg = lat * 180 / Math.PI;
                const lonDeg = lon * 180 / Math.PI;
                
                // Valida√ß√£o b√°sica para coordenadas do Brasil
                if (latDeg < -35 || latDeg > 5 || lonDeg < -75 || lonDeg > -28) {
                    console.warn('Coordenadas fora dos limites esperados para o Brasil:', latDeg, lonDeg);
                }
                
                return {
                    lat: latDeg,
                    lon: lonDeg
                };
            } catch (error) {
                console.error('Erro na convers√£o UTM:', error, 'Coords:', easting, northing, zone);
                return null;
            }
        }

        // Carregar dados da API
        async function loadData() {
            try {
                // Adiciona timestamp para evitar cache
                const timestamp = new Date().getTime();
                const response = await fetch(`http://localhost:5000/api/projects?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('Dados carregados da API em:', new Date().toLocaleString());
                console.log('Registros encontrados:', data.length);
                
                // Processa os dados da API (j√° vem no formato correto)
                projetosData = data.map((projeto, index) => {
                    // Garante ID √∫nico
                    projeto.id = projeto.id || `projeto-${index}`;
                    return projeto;
                });

                projetosFiltrados = [...projetosData];
                renderProjects();
            } catch (error) {
                console.error('Erro ao carregar dados da API:', error);
                
                // Tenta carregar do JSON como fallback
                console.log('Tentando carregar do JSON como fallback...');
                try {
                    const timestamp = new Date().getTime();
                    const response = await fetch(`planilha_portos.json?t=${timestamp}`);
                    const jsonData = await response.json();
                    
                    console.log('Dados carregados do JSON em:', new Date().toLocaleString());
                    console.log('Registros encontrados:', jsonData['Tabela 00 - Cadastro']?.length || 0);
                    
                    const cadastros = jsonData['Tabela 00 - Cadastro'] || [];
                    const servicos = jsonData['Tabela 01 - Servi√ßos'] || [];
                    const acompanhamentos = jsonData['Tabela 02 - Acompanhamento'] || [];

                    // Processar projetos (mant√©m l√≥gica original)
                    projetosData = cadastros.map((cadastro, index) => {
                        const projetoId = `projeto-${index}`;
                        const zona = cadastro['Zona portu√°ria'] || 'N√£o informado';
                        const obj = cadastro['Obj. de Concess√£o'] || '';
                        const nomeProjeto = zona === 'N√£o se aplica' ? obj : `${zona} - ${obj}`;

                        // Buscar servi√ßos relacionados
                        const servicosProjeto = servicos.filter(s => 
                            s['Zona portu√°ria'] === cadastro['Zona portu√°ria'] &&
                            s['UF'] === cadastro['UF'] &&
                            s['Obj. de Concess√£o'] === cadastro['Obj. de Concess√£o']
                        );

                        // Buscar acompanhamentos relacionados
                        const acompanhamentosProjeto = acompanhamentos.filter(a => 
                            a['Zona portu√°ria'] === cadastro['Zona portu√°ria'] &&
                            a['UF'] === cadastro['UF'] &&
                            a['Obj. de Concess√£o'] === cadastro['Obj. de Concess√£o']
                        );

                        // Calcular progresso baseado no acompanhamento mais recente
                        let progresso = 0;
                        if (acompanhamentosProjeto.length > 0) {
                            const maisRecente = acompanhamentosProjeto.sort((a, b) => {
                                const dataA = new Date(a['Data da atualiza√ß√£o'] || 0);
                                const dataB = new Date(b['Data da atualiza√ß√£o'] || 0);
                                return dataB - dataA;
                            })[0];
                            progresso = (maisRecente['% executada'] || 0) * 100;
                        }

                        // ETAPA baseada no status dos servi√ßos
                        let etapa = 'Planejamento';
                        const servicosEmExecucao = servicosProjeto.filter(s => {
                            if (!s['Data de in√≠cio'] || !s['Data final']) return false;
                            const inicio = new Date(s['Data de in√≠cio']);
                            const fim = new Date(s['Data final']);
                            const hoje = new Date();
                            return hoje >= inicio && hoje <= fim;
                        });
                        if (servicosEmExecucao.length > 0) {
                            etapa = `Execu√ß√£o - ${servicosEmExecucao.length} servi√ßo(s) em andamento`;
                        } else if (progresso > 0) {
                            etapa = 'Em execu√ß√£o';
                        }

                        // Mapa - converter coordenadas se dispon√≠vel
                        let mapaEmbed = null;
                        let coordenadasLatLon = null;
                        
                        // Verifica se j√° tem Lat/Lon direto ou precisa converter UTM
                        if (cadastro['Latitude'] && cadastro['Longitude']) {
                            // Usa coordenadas diretas (Lat/Lon)
                            coordenadasLatLon = {
                                lat: parseFloat(cadastro['Latitude']),
                                lon: parseFloat(cadastro['Longitude'])
                            };
                            console.log(`Usando coordenadas diretas para ${nomeProjeto}:`, coordenadasLatLon);
                        } else if (cadastro['Coordenada E (UTM)'] && cadastro['Coordenada S (UTM)'] && cadastro['Fuso']) {
                            // Converte de UTM para Lat/Lon
                            const coordE = parseFloat(cadastro['Coordenada E (UTM)']);
                            const coordS = parseFloat(cadastro['Coordenada S (UTM)']);
                            const fuso = parseInt(cadastro['Fuso']);
                            
                            console.log(`Convertendo coordenadas UTM para ${nomeProjeto}:`, {coordE, coordS, fuso});
                            
                            const latLon = utmToLatLon(coordE, coordS, fuso);
                            if (latLon && !isNaN(latLon.lat) && !isNaN(latLon.lon)) {
                                coordenadasLatLon = latLon;
                                console.log(`Coordenadas convertidas para ${nomeProjeto}:`, latLon);
                            } else {
                                console.warn(`Falha na convers√£o de coordenadas UTM para ${nomeProjeto}:`, latLon);
                            }
                        } else {
                            console.log(`Coordenadas n√£o dispon√≠veis para ${nomeProjeto}:`, {
                                latitude: cadastro['Latitude'],
                                longitude: cadastro['Longitude'],
                                easting: cadastro['Coordenada E (UTM)'],
                                northing: cadastro['Coordenada S (UTM)'],
                                zone: cadastro['Fuso']
                            });
                        }
                        
                        // Gera o mapa se tiver coordenadas v√°lidas
                        if (coordenadasLatLon && !isNaN(coordenadasLatLon.lat) && !isNaN(coordenadasLatLon.lon)) {
                            // Usar OpenStreetMap com bounding box adequada
                            const bboxSize = 0.02; // ~2km de bbox
                            const bbox = `${coordenadasLatLon.lon-bboxSize},${coordenadasLatLon.lat-bboxSize},${coordenadasLatLon.lon+bboxSize},${coordenadasLatLon.lat+bboxSize}`;
                            
                            mapaEmbed = `
                                <div class="w-full h-full relative">
                                    <iframe 
                                        width="100%" 
                                        height="100%" 
                                        style="border:0; border-radius: 8px;" 
                                        src="https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${coordenadasLatLon.lat},${coordenadasLatLon.lon}" 
                                        frameborder="0"
                                        allowfullscreen>
                                    </iframe>
                                    <div class="absolute bottom-2 left-2 bg-white bg-opacity-90 px-2 py-1 rounded text-xs text-gray-700">
                                        üìç ${coordenadasLatLon.lat.toFixed(6)}, ${coordenadasLatLon.lon.toFixed(6)}
                                    </div>
                                </div>
                            `;
                        }

                        return {
                            id: projetoId,
                            nome: nomeProjeto,
                            zona: zona,
                            uf: cadastro['UF'] || '',
                            objConcessao: obj,
                            tipo: cadastro['Tipo'] || '',
                            capexTotal: cadastro['CAPEX Total'] || 0,
                            dataAssinatura: cadastro['Data de assinatura do contrato'] || null,
                            descricao: cadastro['Descri√ß√£o'] || 'Sem descri√ß√£o dispon√≠vel',
                            progresso: progresso,
                            etapa: etapa,
                            servicos: servicosProjeto,
                            acompanhamentos: acompanhamentosProjeto,
                            mapaEmbed: mapaEmbed,
                            coordenadas: {
                                e: cadastro['Coordenada E (UTM)'],
                                s: cadastro['Coordenada S (UTM)'],
                                fuso: cadastro['Fuso'],
                                latitude: cadastro['Latitude'],
                                longitude: cadastro['Longitude']
                            },
                            coordenadasLatLon: coordenadasLatLon
                        };
                    });

                    projetosFiltrados = [...projetosData];
                    renderProjects();
                    console.log('Dados carregados do JSON com sucesso!');
                } catch (jsonError) {
                    console.error('Erro ao carregar do JSON:', jsonError);
                    document.getElementById('projects-grid').innerHTML = 
                        '<div class="col-span-full text-center text-white p-8"><p>Erro ao carregar dados. Verifique se o servidor est√° rodando ou o arquivo JSON est√° dispon√≠vel.</p></div>';
                }
            }
        }

        // Renderizar cards de projetos
        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            
            if (projetosFiltrados.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-white p-8"><p>Nenhum projeto encontrado.</p></div>';
                return;
            }

            grid.innerHTML = projetosFiltrados.map(projeto => {
                const statusColor = projeto.progresso === 0 ? 'bg-gray-400' : 
                                   projeto.progresso < 50 ? 'bg-yellow-500' : 
                                   projeto.progresso < 100 ? 'bg-blue-500' : 'bg-green-500';
                
                return `
                    <div data-id="${projeto.id}" class="project-card bg-white rounded-xl shadow-md p-6 cursor-pointer">
                        <div>
                            <p class="text-sm text-gray-500">${projeto.uf} ‚Ä¢ ${projeto.tipo || 'N/A'}</p>
                            <h3 class="text-lg font-bold mt-1 text-gray-800">${projeto.nome}</h3>
                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">${projeto.descricao}</p>
                        </div>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full ${statusColor} mr-2"></span>
                                <span class="text-sm font-medium text-gray-600">${projeto.etapa}</span>
                            </div>
                            ${projeto.capexTotal > 0 ? `
                                <span class="text-xs text-gray-500">
                                    R$ ${(projeto.capexTotal / 1000000).toFixed(1)}M
                                </span>
                            ` : ''}
                        </div>
                        ${projeto.progresso > 0 ? `
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${projeto.progresso}%"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${projeto.progresso.toFixed(1)}% conclu√≠do</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Renderizar detalhes do projeto no modal
        function renderProjectDetails(projectId) {
            const projeto = projetosData.find(p => p.id === projectId);
            if (!projeto) return;

            const modal = document.getElementById('project-modal');
            const modalContent = document.getElementById('modal-content');
            const modalBody = document.getElementById('modal-body');

            modal.classList.remove('hidden');
            modal.classList.add('flex', 'modal-enter');
            modalContent.classList.remove('modal-leave');

            modalBody.innerHTML = `
                <p class="text-sm font-semibold uppercase tracking-wider text-blue-600">${projeto.uf} ‚Ä¢ ${projeto.tipo || 'N/A'}</p>
                <h2 class="text-4xl font-extrabold text-gray-800 mt-2 mb-6">${projeto.nome}</h2>
                
                <div class="modal-info-grid items-stretch">
                    <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--descricao">
                        <h3 class="text-lg font-bold mb-2 text-gray-700">Descri√ß√£o do Projeto</h3>
                        <p class="text-gray-600 leading-relaxed">${projeto.descricao}</p>
                        <div class="mt-4 text-sm text-gray-600 space-y-1">
                            <p><span class="font-semibold">Zona Portu√°ria:</span> ${projeto.zona}</p>
                            <p><span class="font-semibold">UF:</span> ${projeto.uf}</p>
                            <p><span class="font-semibold">Tipo:</span> ${projeto.tipo || 'N√£o informado'}</p>
                            ${projeto.capexTotal > 0 ? `
                                <p><span class="font-semibold">CAPEX Total:</span> R$ ${projeto.capexTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                            ` : ''}
                            ${projeto.dataAssinatura ? `
                                <p><span class="font-semibold">Data de Assinatura:</span> ${new Date(projeto.dataAssinatura).toLocaleDateString('pt-BR')}</p>
                            ` : ''}
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--mapa">
                        <h3 class="text-lg font-bold mb-2 text-gray-700">Localiza√ß√£o</h3>
                        ${projeto.mapaEmbed
                            ? `
                                <div class="w-full h-48 md:h-full rounded-lg overflow-hidden border border-gray-200 relative">
                                    ${projeto.mapaEmbed}
                                </div>
                                ${projeto.coordenadasLatLon ? `
                                    <div class="mt-3 text-xs text-gray-600 space-y-1">
                                        ${projeto.coordenadas.latitude && projeto.coordenadas.longitude ? `
                                            <p><span class="font-semibold">Coordenadas:</span> ${projeto.coordenadas.latitude.toFixed(6)}¬∞, ${projeto.coordenadas.longitude.toFixed(6)}¬∞</p>
                                        ` : projeto.coordenadas.e && projeto.coordenadas.s ? `
                                            <p><span class="font-semibold">UTM:</span> E=${projeto.coordenadas.e}, S=${projeto.coordenadas.s}, Fuso=${projeto.coordenadas.fuso}</p>
                                            <p><span class="font-semibold">Lat/Lon:</span> ${projeto.coordenadasLatLon.lat.toFixed(6)}¬∞, ${projeto.coordenadasLatLon.lon.toFixed(6)}¬∞</p>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            `
                            : `
                                <div class="w-full h-48 bg-gray-100 rounded-lg border border-dashed border-gray-300 flex items-center justify-center text-gray-500">
                                    <div class="text-center">
                                        <i class="fas fa-map-marked-alt text-3xl mb-2"></i>
                                        <p class="text-sm">Coordenadas n√£o dispon√≠veis</p>
                                        ${projeto.coordenadas.latitude && projeto.coordenadas.longitude ? `
                                            <p class="text-xs mt-1">Lat/Lon: ${projeto.coordenadas.latitude.toFixed(6)}¬∞, ${projeto.coordenadas.longitude.toFixed(6)}¬∞</p>
                                        ` : projeto.coordenadas.e ? `
                                            <p class="text-xs mt-1">UTM: ${projeto.coordenadas.e}, ${projeto.coordenadas.s}</p>
                                        ` : ''}
                                    </div>
                                </div>
                            `
                        }
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl p-4 h-full flex flex-col card--etapa">
                        <h3 class="text-lg font-bold text-gray-700 mb-2">ETAPA:</h3>
                        <p class="text-gray-600 font-semibold text-lg">${projeto.etapa}</p>
                        ${projeto.servicos.length > 0 ? `
                            <div class="mt-3 text-sm text-gray-600">
                                <p class="font-semibold mb-2">Servi√ßos por Fase:</p>
                                ${Object.entries(
                                    projeto.servicos.reduce((acc, s) => {
                                        const fase = s['Fase'] || 'Sem fase';
                                        acc[fase] = (acc[fase] || 0) + 1;
                                        return acc;
                                    }, {})
                                ).map(([fase, count]) => `<p>‚Ä¢ ${fase}: ${count} servi√ßo(s)</p>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Event listeners
        document.getElementById('reload-btn').addEventListener('click', async () => {
            const btn = document.getElementById('reload-btn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Carregando...';
            btn.disabled = true;
            
            try {
                await loadData();
                console.log('Dados recarregados com sucesso!');
            } catch (error) {
                console.error('Erro ao recarregar dados:', error);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            projetosFiltrados = projetosData.filter(projeto => 
                projeto.nome.toLowerCase().includes(searchTerm) ||
                projeto.descricao.toLowerCase().includes(searchTerm) ||
                projeto.uf.toLowerCase().includes(searchTerm) ||
                projeto.zona.toLowerCase().includes(searchTerm)
            );
            renderProjects();
        });

        document.getElementById('projects-grid').addEventListener('click', (e) => {
            const card = e.target.closest('.project-card');
            if (card && card.dataset.id) {
                renderProjectDetails(card.dataset.id);
            }
        });

        document.getElementById('close-modal').addEventListener('click', () => {
            const modal = document.getElementById('project-modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex', 'modal-enter', 'modal-leave');
            }, 300);
        });

        document.getElementById('project-modal').addEventListener('click', (e) => {
            if (e.target.id === 'project-modal') {
                const modal = document.getElementById('project-modal');
                const modalContent = document.getElementById('modal-content');
                modalContent.classList.add('modal-leave');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex', 'modal-enter', 'modal-leave');
                }, 300);
            }
        });

        // Carregar dados ao iniciar
        loadData();
    </script>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
